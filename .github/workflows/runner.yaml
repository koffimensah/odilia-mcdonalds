name: CI/CD Pipeline - odilia-mcdonalds (Security Enhanced)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  security-events: write
  actions: read

# ==========================================================
# ðŸ§¹ CLEANUP JOB (AGGRESSIVE DOCKER WIPE)
# ==========================================================
jobs:
  cleanup:
    runs-on: self-hosted
    steps:
      - name: Disk Space BEFORE Cleanup
        run: |
          echo "===== DISK BEFORE CLEANUP ====="
          df -h
          docker system df || true

      - name: ðŸš¨ Remove ALL Docker containers, images, volumes
        run: |
          echo "Stopping containers..."
          sudo docker ps -aq | xargs -r sudo docker stop || true
          echo "Removing containers..."
          sudo docker ps -aq | xargs -r sudo docker rm -f || true
          echo "Removing images..."
          sudo docker images -aq | xargs -r sudo docker rmi -f || true
          echo "Removing volumes..."
          sudo docker volume ls -q | xargs -r sudo docker volume rm -f || true
          echo "Removing networks..."
          sudo docker network ls -q | xargs -r sudo docker network rm || true
          echo "Removing build cache..."
          sudo docker builder prune -a -f || true

      - name: ðŸ§¹ System Cleanup
        run: |
          sudo apt-get clean || true
          sudo apt-get autoclean || true
          sudo rm -rf /tmp/* || true
          sudo rm -rf /home/ubuntu/actions-runner/_work/_temp/* || true
          sudo journalctl --rotate || true
          sudo journalctl --vacuum-time=1d || true

      - name: Disk Space AFTER Cleanup
        run: |
          echo "===== DISK AFTER CLEANUP ====="
          df -h
          docker system df || true

      - name: Verify Disk Space (soft check)
        run: |
          AVAILABLE=$(df / | tail -1 | awk '{print $4}')
          echo "Available disk space: $AVAILABLE KB"
          if [ "$AVAILABLE" -lt 1000000 ]; then
            echo "âš ï¸ WARNING: Less than 1GB free, continuing anyway"
          else
            echo "âœ… Disk space sufficient"
          fi

# ==========================================================
# ðŸ” SECURITY SCANS (GITLEAKS + SONAR + CHECKOV)
# ==========================================================
  security-scan:
    runs-on: self-hosted
    needs: cleanup
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # ðŸ”‘ Gitleaks
      - name: Gitleaks Secret Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ðŸ“Š SonarQube Scan
      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v6
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: http://52.15.230.38:9000
        # Scanner will read sonar-project.properties from repo root

      # ðŸš¦ Quality Gate
      - name: SonarQube Quality Gate
        uses: SonarSource/sonarqube-quality-gate-action@v1.2.0
        timeout-minutes: 5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_TOKEN }}

      # ðŸ—ï¸ Checkov
      - name: Checkov IaC Scan
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: .
          framework: dockerfile,docker-compose
          output_format: cli,sarif
          output_file_path: console,checkov.sarif

      - name: Upload Checkov SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: checkov.sarif
          category: checkov

# ==========================================================
# ðŸ§ª TESTS (PHP + NODE)
# ==========================================================
  test:
    runs-on: self-hosted
    needs: security-scan
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # ðŸ˜ PHP
      - name: Setup PHP
        if: hashFiles('phpunit.xml') != ''
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          tools: composer, phpunit

      - name: Install PHP Dependencies
        if: hashFiles('composer.json') != ''
        run: composer install --no-interaction --prefer-dist

      - name: Run PHPUnit with Coverage
        if: hashFiles('phpunit.xml') != ''
        run: vendor/bin/phpunit --coverage-clover coverage.xml

      # ðŸŸ¢ Node
      - name: Setup Node.js
        if: hashFiles('package.json') != ''
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: npm

      - name: Install Node Dependencies
        if: hashFiles('package.json') != ''
        run: npm ci

      - name: Run Jest with Coverage
        if: hashFiles('package.json') != ''
        run: npm test -- --coverage

# ==========================================================
# ðŸ³ BUILD & IMAGE SECURITY (TRIVY)
# ==========================================================
  build-and-scan:
    runs-on: self-hosted
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install Docker
        run: sudo apt-get update && sudo apt-get install -y docker.io curl unzip

      - name: DockerHub Login
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Pull Images
        run: |
          docker pull mreferre/yelb-ui:0.7
          docker pull mreferre/yelb-appserver:0.5

      - name: Trivy Scan â€“ UI Image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: mreferre/yelb-ui:0.7
          format: sarif
          output: trivy-ui.sarif
          severity: CRITICAL,HIGH
          exit-code: 1

      - name: Upload Trivy Results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-ui.sarif
          category: trivy

# ==========================================================
# ðŸš€ DEPLOY
# ==========================================================
  deploy:
    runs-on: self-hosted
    needs: build-and-scan
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install Docker Compose
        run: |
          if ! command -v docker-compose &> /dev/null; then
            sudo curl -L https://github.com/docker/compose/releases/download/v2.22.0/docker-compose-$(uname -s)-$(uname -m) -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
          fi
          docker-compose version

      - name: Deploy Application
        run: docker-compose up -d

      - name: Smoke Test
        run: |
          sleep 10
          curl -f http://localhost/ || exit 1
          echo "âœ… Application is running"

      - name: Final Cleanup
        if: always()
        run: sudo docker system prune -f
