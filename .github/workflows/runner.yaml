name: CI/CD Pipeline - odilia-mcdonalds (Security Enhanced)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  security-events: write
  actions: read

# ==========================================================
# ðŸ§¹ CLEANUP JOB (AGGRESSIVE DOCKER WIPE)
# ==========================================================
jobs:
  cleanup:
    runs-on: self-hosted
    timeout-minutes: 15
    steps:
      - name: Install and Start Docker
        run: |
          # Check if Docker is installed
          if ! command -v docker &> /dev/null; then
            echo "Docker not found, installing..."
            sudo apt-get update
            sudo apt-get install -y docker.io
            sudo systemctl start docker
            sudo systemctl enable docker
          else
            echo "Docker already installed"
            sudo systemctl start docker || true
          fi
          
          # Fix Docker socket permissions
          sudo chmod 666 /var/run/docker.sock
          
          # Add current user to docker group
          sudo usermod -aG docker $USER || true
          
          # Wait for Docker to be ready
          sleep 5
          docker --version
          
      - name: Disk Space BEFORE Cleanup
        run: |
          echo "===== DISK BEFORE CLEANUP ====="
          df -h
          docker system df || true

      - name: ðŸš¨ AGGRESSIVE Docker Cleanup
        run: |
          echo "Stopping ALL containers..."
          docker stop $(docker ps -aq) 2>/dev/null || true
          
          echo "Removing ALL containers..."
          docker rm -f $(docker ps -aq) 2>/dev/null || true
          
          echo "Removing ALL images..."
          docker rmi -f $(docker images -aq) 2>/dev/null || true
          
          echo "Removing ALL volumes..."
          docker volume rm -f $(docker volume ls -q) 2>/dev/null || true
          
          echo "Removing custom networks..."
          docker network prune -f || true
          
          echo "Pruning ALL Docker data..."
          docker system prune -a -f --volumes || true
          
          echo "Removing build cache..."
          docker builder prune -a -f || true

      - name: ðŸ§¹ Aggressive System Cleanup
        run: |
          echo "Cleaning apt cache..."
          sudo apt-get clean || true
          sudo apt-get autoclean || true
          sudo apt-get autoremove -y || true
          
          echo "Cleaning temporary files..."
          sudo rm -rf /tmp/* 2>/dev/null || true
          sudo rm -rf /var/tmp/* 2>/dev/null || true
          sudo rm -rf /home/ubuntu/actions-runner/_work/_temp/* 2>/dev/null || true
          sudo rm -rf /home/ubuntu/actions-runner/_work/odilia-mcdonalds/odilia-mcdonalds/.git/lfs 2>/dev/null || true
          
          echo "Cleaning journals..."
          sudo journalctl --rotate || true
          sudo journalctl --vacuum-time=1d || true
          
          echo "Cleaning old kernels..."
          sudo apt-get autoremove --purge -y || true
          
          echo "Cleaning package cache..."
          sudo rm -rf /var/cache/apt/archives/* 2>/dev/null || true
          
          echo "Cleaning Trivy cache..."
          rm -rf ~/.cache/trivy 2>/dev/null || true
          
          echo "Cleaning npm cache..."
          npm cache clean --force 2>/dev/null || true
          
          echo "Cleaning pip cache..."
          rm -rf ~/.cache/pip 2>/dev/null || true

      - name: Disk Space AFTER Cleanup
        run: |
          echo "===== DISK AFTER CLEANUP ====="
          df -h
          docker system df || true

      - name: Verify Disk Space
        run: |
          AVAILABLE=$(df / | tail -1 | awk '{print $4}')
          echo "Available disk space: $AVAILABLE KB (~$((AVAILABLE/1024/1024)) GB)"
          if [ "$AVAILABLE" -lt 500000 ]; then
            echo "âŒ ERROR: Less than 500MB free - critically low space!"
            exit 1
          elif [ "$AVAILABLE" -lt 2000000 ]; then
            echo "âš ï¸ WARNING: Less than 2GB free - workflow may fail!"
          else
            echo "âœ… Disk space sufficient: $((AVAILABLE/1024/1024)) GB free"
          fi

# ==========================================================
# ðŸ” SECURITY SCANS (GITLEAKS + SONAR + CHECKOV)
# ==========================================================
  security-scan:
    runs-on: self-hosted
    needs: cleanup
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ðŸ”‘ Gitleaks
      - name: Gitleaks Secret Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
        
      - name: Upload Gitleaks SARIF
        if: always() && hashFiles('results.sarif') != ''
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: results.sarif
          category: gitleaks

      # ðŸ“Š SonarQube Scan - Using CLI instead of Docker action
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Download and Install SonarScanner
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y unzip
          wget -q https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
          unzip -q sonar-scanner-cli-5.0.1.3006-linux.zip
          echo "$GITHUB_WORKSPACE/sonar-scanner-5.0.1.3006-linux/bin" >> $GITHUB_PATH

      - name: Run SonarQube Scan
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: http://52.15.230.38:9000
        run: |
          sonar-scanner \
            -Dsonar.projectKey=${{ github.repository_owner }}_${{ github.event.repository.name }} \
            -Dsonar.sources=. \
            -Dsonar.exclusions=**/node_modules/**,**/vendor/** \
            -Dsonar.host.url=$SONAR_HOST_URL \
            -Dsonar.token=$SONAR_TOKEN

      # ðŸš¦ Quality Gate
      - name: SonarQube Quality Gate
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: http://52.15.230.38:9000
        run: |
          # Wait for analysis to complete
          sleep 10
          
          # Get the quality gate status
          PROJECT_KEY="${{ github.repository_owner }}_${{ github.event.repository.name }}"
          QUALITY_GATE_STATUS=$(curl -s -u "$SONAR_TOKEN:" \
            "$SONAR_HOST_URL/api/qualitygates/project_status?projectKey=$PROJECT_KEY" \
            | grep -o '"status":"[^"]*"' | cut -d'"' -f4)
          
          echo "Quality Gate Status: $QUALITY_GATE_STATUS"
          
          if [ "$QUALITY_GATE_STATUS" != "OK" ]; then
            echo "âŒ Quality Gate failed!"
            exit 1
          fi
          
          echo "âœ… Quality Gate passed!"
        continue-on-error: true

      # ðŸ—ï¸ Checkov - Install via pip for GitHub-hosted runners
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Checkov
        run: pip install checkov

      - name: Run Checkov IaC Scan
        run: |
          checkov -d . \
            --framework dockerfile docker_compose \
            --output cli sarif \
            --output-file-path console,checkov.sarif \
            --soft-fail
        continue-on-error: true

      - name: Upload Checkov SARIF
        if: always() && hashFiles('checkov.sarif') != ''
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: checkov.sarif
          category: checkov

# ==========================================================
# ðŸ§ª TESTS (PHP + NODE)
# ==========================================================
  test:
    runs-on: self-hosted
    needs: security-scan
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ðŸ˜ PHP
      - name: Setup PHP
        if: hashFiles('phpunit.xml') != ''
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          tools: composer, phpunit

      - name: Install PHP Dependencies
        if: hashFiles('composer.json') != ''
        run: composer install --no-interaction --prefer-dist --no-progress

      - name: Run PHPUnit with Coverage
        if: hashFiles('phpunit.xml') != ''
        run: vendor/bin/phpunit --coverage-clover coverage.xml

      # ðŸŸ¢ Node
      - name: Setup Node.js
        if: hashFiles('package.json') != ''
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install Node Dependencies
        if: hashFiles('package.json') != ''
        run: npm ci

      - name: Run Jest with Coverage
        if: hashFiles('package.json') != ''
        run: npm test -- --coverage

# ==========================================================
# ðŸ³ BUILD & IMAGE SECURITY (TRIVY)
# ==========================================================
  build-and-scan:
    runs-on: self-hosted
    needs: test
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Disk Space Before Build
        run: |
          echo "Disk space before build:"
          df -h
          AVAILABLE=$(df / | tail -1 | awk '{print $4}')
          echo "DISK_SPACE_KB=$AVAILABLE" >> $GITHUB_ENV
          if [ "$AVAILABLE" -lt 500000 ]; then
            echo "âŒ ERROR: Less than 500MB free - not enough for build!"
            exit 1
          fi

      - name: Fix Docker Permissions
        run: |
          sudo systemctl start docker || true
          sudo chmod 666 /var/run/docker.sock
          sleep 3
          docker ps
          
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: DockerHub Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Pull Images
        run: |
          docker pull mreferre/yelb-ui:0.7
          docker pull mreferre/yelb-appserver:0.5

      - name: Trivy Scan â€“ UI Image (if space available)
        if: env.DISK_SPACE_KB > 3000000
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          image-ref: mreferre/yelb-ui:0.7
          format: sarif
          output: trivy-ui.sarif
          severity: CRITICAL,HIGH
          exit-code: 0
          timeout: 15m0s
        env:
          TRIVY_TEMP_DIR: /tmp/trivy-temp
          TRIVY_SKIP_DB_UPDATE: false

      - name: Trivy Scan â€“ AppServer Image (if space available)
        if: env.DISK_SPACE_KB > 3000000
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          image-ref: mreferre/yelb-appserver:0.5
          format: sarif
          output: trivy-appserver.sarif
          severity: CRITICAL,HIGH
          exit-code: 0
          timeout: 15m0s
        env:
          TRIVY_TEMP_DIR: /tmp/trivy-temp
          TRIVY_SKIP_DB_UPDATE: false
          
      - name: Note about Trivy Scans
        if: env.DISK_SPACE_KB <= 3000000
        run: |
          echo "âš ï¸ Skipping Trivy scans due to low disk space"
          echo "Available: ${{ env.DISK_SPACE_KB }} KB (~$((${{ env.DISK_SPACE_KB }}/1024/1024)) GB)"
          echo "Required: At least 3GB for Trivy image scanning"
          echo "Please increase disk size or manually run: trivy image mreferre/yelb-ui:0.7"

      - name: Upload Trivy UI Results
        if: always() && hashFiles('trivy-ui.sarif') != ''
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-ui.sarif
          category: trivy-ui

      - name: Upload Trivy AppServer Results
        if: always() && hashFiles('trivy-appserver.sarif') != ''
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-appserver.sarif
          category: trivy-appserver

# ==========================================================
# ðŸš€ DEPLOY (Docker Compose + ArgoCD Ready)
# ==========================================================
  deploy:
    runs-on: self-hosted
    needs: build-and-scan
    timeout-minutes: 20
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ==========================================================
      # DOCKER COMPOSE DEPLOYMENT (CURRENT)
      # ==========================================================
      - name: Ensure Docker is Running
        run: |
          sudo systemctl start docker || true
          sudo chmod 666 /var/run/docker.sock
          sleep 3
          docker ps

      - name: Install Docker Compose
        run: |
          if ! command -v docker-compose &> /dev/null && ! docker compose version &> /dev/null; then
            echo "Installing Docker Compose..."
            sudo curl -L "https://github.com/docker/compose/releases/download/v2.24.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
            sudo ln -sf /usr/local/bin/docker-compose /usr/bin/docker-compose
          fi
          docker-compose --version || docker compose version

      - name: Deploy with Docker Compose
        run: |
          if command -v docker-compose &> /dev/null; then
            docker-compose up -d
          else
            docker compose up -d
          fi

      - name: Wait for Application Startup
        run: sleep 10

      - name: Smoke Test
        run: |
          MAX_RETRIES=5
          RETRY_COUNT=0
          until curl -f http://localhost/ || [ $RETRY_COUNT -eq $MAX_RETRIES ]; do
            echo "Attempt $((RETRY_COUNT+1)) of $MAX_RETRIES failed. Retrying in 5 seconds..."
            sleep 5
            RETRY_COUNT=$((RETRY_COUNT+1))
          done
          
          if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
            echo "âŒ Application failed to start after $MAX_RETRIES attempts"
            docker-compose logs || docker compose logs
            exit 1
          fi
          
          echo "âœ… Application is running"

      # ==========================================================
      # ARGOCD DEPLOYMENT (COMMENTED - ENABLE WHEN K8S IS READY)
      # ==========================================================
      # Uncomment these steps once you have:
      # 1. Kubernetes cluster running
      # 2. ArgoCD installed (kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml)
      # 3. GitHub secrets configured: ARGOCD_SERVER, ARGOCD_AUTH_TOKEN
      # 4. Kubernetes manifests in k8s/ directory
      
      # - name: Install ArgoCD CLI
      #   run: |
      #     if ! command -v argocd &> /dev/null; then
      #       curl -sSL -o /tmp/argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
      #       sudo install -m 555 /tmp/argocd /usr/local/bin/argocd
      #       rm /tmp/argocd
      #     fi
      #     argocd version --client

      # - name: Login to ArgoCD
      #   env:
      #     ARGOCD_SERVER: ${{ secrets.ARGOCD_SERVER }}
      #     ARGOCD_AUTH_TOKEN: ${{ secrets.ARGOCD_AUTH_TOKEN }}
      #   run: |
      #     argocd login $ARGOCD_SERVER \
      #       --auth-token $ARGOCD_AUTH_TOKEN \
      #       --insecure \
      #       --grpc-web

      # - name: Create/Update ArgoCD Application
      #   env:
      #     ARGOCD_SERVER: ${{ secrets.ARGOCD_SERVER }}
      #     ARGOCD_AUTH_TOKEN: ${{ secrets.ARGOCD_AUTH_TOKEN }}
      #   run: |
      #     if argocd app get odilia-mcdonalds --auth-token $ARGOCD_AUTH_TOKEN --server $ARGOCD_SERVER --insecure 2>/dev/null; then
      #       argocd app set odilia-mcdonalds \
      #         --repo https://github.com/${{ github.repository }}.git \
      #         --revision ${{ github.ref_name }} \
      #         --path k8s \
      #         --auth-token $ARGOCD_AUTH_TOKEN \
      #         --server $ARGOCD_SERVER \
      #         --insecure
      #     else
      #       argocd app create odilia-mcdonalds \
      #         --repo https://github.com/${{ github.repository }}.git \
      #         --revision ${{ github.ref_name }} \
      #         --path k8s \
      #         --dest-server https://kubernetes.default.svc \
      #         --dest-namespace default \
      #         --sync-policy automated \
      #         --self-heal \
      #         --auto-prune \
      #         --auth-token $ARGOCD_AUTH_TOKEN \
      #         --server $ARGOCD_SERVER \
      #         --insecure
      #     fi

      # - name: Sync ArgoCD Application
      #   env:
      #     ARGOCD_SERVER: ${{ secrets.ARGOCD_SERVER }}
      #     ARGOCD_AUTH_TOKEN: ${{ secrets.ARGOCD_AUTH_TOKEN }}
      #   run: |
      #     argocd app sync odilia-mcdonalds \
      #       --auth-token $ARGOCD_AUTH_TOKEN \
      #       --server $ARGOCD_SERVER \
      #       --insecure \
      #       --prune

      # - name: Wait for Deployment
      #   env:
      #     ARGOCD_SERVER: ${{ secrets.ARGOCD_SERVER }}
      #     ARGOCD_AUTH_TOKEN: ${{ secrets.ARGOCD_AUTH_TOKEN }}
      #   run: |
      #     argocd app wait odilia-mcdonalds \
      #       --auth-token $ARGOCD_AUTH_TOKEN \
      #       --server $ARGOCD_SERVER \
      #       --insecure \
      #       --health \
      #       --timeout 300

      - name: Final Cleanup
        if: always()
        run: docker system prune -f