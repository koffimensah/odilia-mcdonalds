name: CI/CD Pipeline - odilia-mcdonalds (Security Enhanced)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  security-events: write
  actions: read

# ==========================================================
# üßπ CLEANUP JOB (AGGRESSIVE DOCKER WIPE)
# ==========================================================
jobs:
  cleanup:
    runs-on: self-hosted
    timeout-minutes: 15
    steps:
      - name: Start Docker Service
        run: |
          sudo systemctl start docker || true
          sleep 3
          
      - name: Disk Space BEFORE Cleanup
        run: |
          echo "===== DISK BEFORE CLEANUP ====="
          df -h
          docker system df || true

      - name: üö® Remove ALL Docker containers, images, volumes
        run: |
          echo "Stopping containers..."
          sudo docker ps -aq | xargs -r sudo docker stop || true
          echo "Removing containers..."
          sudo docker ps -aq | xargs -r sudo docker rm -f || true
          echo "Removing images..."
          sudo docker images -aq | xargs -r sudo docker rmi -f || true
          echo "Removing volumes..."
          sudo docker volume ls -q | xargs -r sudo docker volume rm -f || true
          echo "Removing networks..."
          sudo docker network ls -q --filter type=custom | xargs -r sudo docker network rm || true
          echo "Removing build cache..."
          sudo docker builder prune -a -f || true

      - name: üßπ System Cleanup
        run: |
          sudo apt-get clean || true
          sudo apt-get autoclean || true
          sudo rm -rf /tmp/* || true
          sudo rm -rf /home/ubuntu/actions-runner/_work/_temp/* || true
          sudo journalctl --rotate || true
          sudo journalctl --vacuum-time=1d || true

      - name: Disk Space AFTER Cleanup
        run: |
          echo "===== DISK AFTER CLEANUP ====="
          df -h
          docker system df || true

      - name: Verify Disk Space (soft check)
        run: |
          AVAILABLE=$(df / | tail -1 | awk '{print $4}')
          echo "Available disk space: $AVAILABLE KB"
          if [ "$AVAILABLE" -lt 1000000 ]; then
            echo "‚ö†Ô∏è WARNING: Less than 1GB free, continuing anyway"
          else
            echo "‚úÖ Disk space sufficient"
          fi

# ==========================================================
# üîê SECURITY SCANS (GITLEAKS + SONAR + CHECKOV)
# ==========================================================
  security-scan:
    runs-on: self-hosted
    needs: cleanup
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # üîë Gitleaks
      - name: Gitleaks Secret Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
        
      - name: Upload Gitleaks SARIF
        if: always() && hashFiles('results.sarif') != ''
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: results.sarif
          category: gitleaks

      # üìä SonarQube Scan - Using CLI instead of Docker action
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Download and Install SonarScanner
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y unzip
          wget -q https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
          unzip -q sonar-scanner-cli-5.0.1.3006-linux.zip
          echo "$GITHUB_WORKSPACE/sonar-scanner-5.0.1.3006-linux/bin" >> $GITHUB_PATH

      - name: Run SonarQube Scan
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: http://52.15.230.38:9000
        run: |
          sonar-scanner \
            -Dsonar.projectKey=${{ github.repository_owner }}_${{ github.event.repository.name }} \
            -Dsonar.sources=. \
            -Dsonar.exclusions=**/node_modules/**,**/vendor/** \
            -Dsonar.host.url=$SONAR_HOST_URL \
            -Dsonar.token=$SONAR_TOKEN

      # üö¶ Quality Gate
      - name: SonarQube Quality Gate
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: http://52.15.230.38:9000
        run: |
          # Wait for analysis to complete
          sleep 10
          
          # Get the quality gate status
          PROJECT_KEY="${{ github.repository_owner }}_${{ github.event.repository.name }}"
          QUALITY_GATE_STATUS=$(curl -s -u "$SONAR_TOKEN:" \
            "$SONAR_HOST_URL/api/qualitygates/project_status?projectKey=$PROJECT_KEY" \
            | grep -o '"status":"[^"]*"' | cut -d'"' -f4)
          
          echo "Quality Gate Status: $QUALITY_GATE_STATUS"
          
          if [ "$QUALITY_GATE_STATUS" != "OK" ]; then
            echo "‚ùå Quality Gate failed!"
            exit 1
          fi
          
          echo "‚úÖ Quality Gate passed!"
        continue-on-error: true

      # üèóÔ∏è Checkov - Install via pip for GitHub-hosted runners
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Checkov
        run: pip install checkov

      - name: Run Checkov IaC Scan
        run: |
          checkov -d . \
            --framework dockerfile docker_compose \
            --output cli sarif \
            --output-file-path console,checkov.sarif \
            --soft-fail
        continue-on-error: true

      - name: Upload Checkov SARIF
        if: always() && hashFiles('checkov.sarif') != ''
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: checkov.sarif
          category: checkov

# ==========================================================
# üß™ TESTS (PHP + NODE)
# ==========================================================
  test:
    runs-on: self-hosted
    needs: security-scan
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # üêò PHP
      - name: Setup PHP
        if: hashFiles('phpunit.xml') != ''
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          tools: composer, phpunit

      - name: Install PHP Dependencies
        if: hashFiles('composer.json') != ''
        run: composer install --no-interaction --prefer-dist --no-progress

      - name: Run PHPUnit with Coverage
        if: hashFiles('phpunit.xml') != ''
        run: vendor/bin/phpunit --coverage-clover coverage.xml

      # üü¢ Node
      - name: Setup Node.js
        if: hashFiles('package.json') != ''
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install Node Dependencies
        if: hashFiles('package.json') != ''
        run: npm ci

      - name: Run Jest with Coverage
        if: hashFiles('package.json') != ''
        run: npm test -- --coverage

# ==========================================================
# üê≥ BUILD & IMAGE SECURITY (TRIVY)
# ==========================================================
  build-and-scan:
    runs-on: self-hosted
    needs: test
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Start Docker Service
        run: |
          sudo systemctl start docker
          sudo systemctl status docker --no-pager
          sudo usermod -aG docker $USER
          
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: DockerHub Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Pull Images
        run: |
          docker pull mreferre/yelb-ui:0.7
          docker pull mreferre/yelb-appserver:0.5

      - name: Trivy Scan ‚Äì UI Image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: mreferre/yelb-ui:0.7
          format: sarif
          output: trivy-ui.sarif
          severity: CRITICAL,HIGH
          exit-code: 0

      - name: Trivy Scan ‚Äì AppServer Image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: mreferre/yelb-appserver:0.5
          format: sarif
          output: trivy-appserver.sarif
          severity: CRITICAL,HIGH
          exit-code: 0

      - name: Upload Trivy UI Results
        if: always() && hashFiles('trivy-ui.sarif') != ''
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-ui.sarif
          category: trivy-ui

      - name: Upload Trivy AppServer Results
        if: always() && hashFiles('trivy-appserver.sarif') != ''
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-appserver.sarif
          category: trivy-appserver

# ==========================================================
# üöÄ DEPLOY
# ==========================================================
  deploy:
    runs-on: self-hosted
    needs: build-and-scan
    timeout-minutes: 20
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Start Docker Service
        run: |
          sudo systemctl start docker
          sudo systemctl status docker --no-pager

      - name: Install Docker Compose
        run: |
          # Docker Compose v2 is already installed on GitHub-hosted runners
          docker compose version

      - name: Deploy Application
        run: docker compose up -d

      - name: Wait for Application Startup
        run: sleep 10

      - name: Smoke Test
        run: |
          MAX_RETRIES=5
          RETRY_COUNT=0
          until curl -f http://localhost/ || [ $RETRY_COUNT -eq $MAX_RETRIES ]; do
            echo "Attempt $((RETRY_COUNT+1)) of $MAX_RETRIES failed. Retrying in 5 seconds..."
            sleep 5
            RETRY_COUNT=$((RETRY_COUNT+1))
          done
          
          if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
            echo "‚ùå Application failed to start after $MAX_RETRIES attempts"
            docker-compose logs
            exit 1
          fi
          
          echo "‚úÖ Application is running"

      - name: Final Cleanup
        if: always()
        run: sudo docker system prune -f