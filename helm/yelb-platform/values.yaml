# Umbrella-global overrides; these will be passed to subcharts under the release name.
global:
  redis:
    password: "a-very-complex-password-here"
  postgres:
    username: "postgres"
    password: "postgres"    # change for production
    database: "votes"

# -------------------
# Yelb UI
# -------------------
yelb-ui:
  replicaCount: 1
  image:
    repository: mreferre/yelb-ui
    tag: "0.7"
  service:
    type: NodePort
    port: 80
    targetPort: 3000
  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 250m
      memory: 256Mi

# -------------------
# Yelb AppServer
# -------------------
yelb-appserver:
  replicaCount: 1
  image:
    repository: mreferre/yelb-appserver
    tag: "0.5"
  service:
    type: ClusterIP
    port: 4567
    targetPort: 4567
  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 250m
      memory: 256Mi

# -------------------
# Redis Master (FIXED)
# -------------------
redis-master:
  replicas: 1
  persistence:
    enabled: false   # disable PVC for Minikube
  image:
    repository: redis
    tag: "4.0.2"

  # ðŸ”´ IMPORTANT FIX: override command so redis.conf is NOT used
  command:
    - sh
    - -c
    - |
      redis-server \
        --protected-mode no \
        --port 6379 \
        --requirepass ${REDIS_PASSWORD} \
        --masterauth ${REDIS_PASSWORD}

  service:
    type: ClusterIP
    port: 6379
    targetPort: 6379

# -------------------
# Redis Replicas
# -------------------
redis-replicas:
  replicas: 2
  persistence:
    enabled: false
  image:
    repository: redis
    tag: "4.0.2"
  service:
    type: ClusterIP
    port: 6379
    targetPort: 6379

# -------------------
# Redis Sentinel
# -------------------
redis-sentinel:
  replicas: 3
  image:
    repository: redis
    tag: "4.0.2"
  service:
    type: ClusterIP
    port: 26379
    targetPort: 26379
  configMap:
    sentinel.conf: |
      port 26379
      dir /tmp
      sentinel monitor mymaster yelb-redis-master-redis 6379 2
      sentinel auth-pass mymaster a-very-complex-password-here
      sentinel down-after-milliseconds mymaster 5000
      sentinel parallel-syncs mymaster 1
      sentinel failover-timeout mymaster 60000

# -------------------
# Postgres Primary
# -------------------
postgres-primary:
  replicas: 1
  image:
    repository: mreferre/yelb-db
    tag: "0.5"
  persistence:
    size: 2Gi
  service:
    type: ClusterIP
    port: 5432
    targetPort: 5432

# -------------------
# Postgres Replicas
# -------------------
postgres-replicas:
  replicas: 3
  image:
    repository: mreferre/yelb-db
    tag: "0.5"
  persistence:
    size: 2Gi
  service:
    type: ClusterIP
    port: 5432
    targetPort: 5432
